# Copyright 2021 EPAM Systems
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

name: Promote

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version'
        required: true

env:
  REPOSITORY_URL: 'https://maven.pkg.github.com/'
  UPSTREAM_REPOSITORY_URL: 'https://oss.sonatype.org/'
  PACKAGE_SUFFIXES: '-javadoc.jar,-javadoc.jar.asc,-sources.jar,-sources.jar.asc,.jar,.jar.asc,.pom,.pom.asc'
  PACKAGE: 'com.epam.reportportal'


jobs:
  build:
    runs-on: ubuntu-latest

    steps:

      - name: Set up JDK 1.8
        uses: actions/setup-java@v1
        with:
          java-version: 1.8

      - name: Get variables
        run: |
          echo "ARTIFACT=`echo ${{ github.repository }} | cut -d/ -f2-`" >> $GITHUB_ENV
          echo "PACKAGE_PATH=`echo ${{ env.PACKAGE }} | sed 's/\./\//g'`" >> $GITHUB_ENV

      - name: Promote packages
        run: |
          IFS=',' read -a files <<< '${{ env.PACKAGE_SUFFIXES }}'
          for f in ${files[@]}; do
            export URL="${{ env.REPOSITORY_URL }}${{ github.repository }}/${PACKAGE_PATH}/${ARTIFACT}/${{ github.event.inputs.version }}/${ARTIFACT}-${{ github.event.inputs.version }}${f}"
            echo "Downloading artifact: ${URL}"
            curl -u ${{ github.actor }}:${{ secrets.GITHUB_TOKEN }} -s -O -L "${URL}"
          done
          files=($(ls))
          echo 'Files downloaded:'
          echo "${files[@]}"

          echo 'Bundle generation'
          export BUNDLE_FILE="${ARTIFACT}-${{ github.event.inputs.version }}-bundle.jar"
          jar -cvf ${BUNDLE_FILE} "${files[@]}"


          echo 'Bundle upload'
          curl -u ${{ secrets.SONATYPE_USER }}:${{ secrets.SONATYPE_PASSWORD }} -L \
            --request POST '${{ env.UPSTREAM_REPOSITORY_URL }}service/local/staging/bundle_upload' \
            --form "file=@${BUNDLE_FILE}"
